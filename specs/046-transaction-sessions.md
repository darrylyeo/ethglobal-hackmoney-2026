# Spec 046: Transaction sessions

Introduce transaction sessions that track a transaction flow from draft to
submission to on-chain finalization. Transaction flow pages create, persist, and
sync sessions via a dedicated TanStack DB collection, with URL-hash driven entry
and navigation.

## Scope

- All pages that render a transaction flow (TransactionFlow-backed routes).
- Dedicated `transaction-sessions` TanStack DB collection.
- URL hash handling for session bootstrap and navigation.
- Session lifecycle and edit locking rules.
- Normalize session params at the collection boundary using ArkType.
- Navigation state tags for Draft, Submitted, Finalized.
- Replace legacy per-flow hash state and local draft state.

## Non-goals

- No backward compatibility for legacy hash formats.
- No duplicate draft state outside the session object.
- No new analytics or telemetry.

## Definitions

### Transaction session

A persisted record that represents a transaction session, containing one or more
actions (swap, transfer, bridge) that together define the user flow.

### Lifecycle

- `Draft`: editable parameters, no on-chain submission.
- `Submitted`: parameters locked, transaction hash known.
- `Finalized`: on-chain finalization confirmed.

## Data model sketch

```typescript
type Session = {
	id: string
	name?: string  // optional; autogenerated from first action label when created from hash
	actions: (
		| 'swap'
		| 'bridge'
		| 'transfer'
	)[]
	status: 'Draft' | 'Submitted' | 'Finalized'
	createdAt: number
	updatedAt: number
	lockedAt?: number
	params: Record<string, unknown>
	latestSimulationId?: string
	simulationCount?: number
	execution?: {
		submittedAt: number
		txHash?: `0x${string}`
		chainId?: number
	}
	finalization?: {
		at: number
		receipt?: Record<string, unknown>
	}
}
```

## URL and shallow routing rules

### Bootstrap

**Superseded by spec 101.** See `specs/101-session-url-model.md` for the current
local-session URL model (`?template=`, `?session=`), persist on first edit, and
redirect to `/session/[id]`.

- Single base route: `/session`.
- Session initialization uses SvelteKit shallow routing (`page.state.sessionState`) for in-app navigation, with search params for direct links:
  - `?template=[action-slug]` (e.g. `?template=Swap`, `?template=Bridge`)
  - `?actions=[action-1-slug]|[action-2-slug]` for multi-action
  - `?actions=[action-1-slug]:{JSON params}|[action-2-slug]:{JSON params}` with params
- When the state/search params contain action slugs (or are empty), **do not persist yet**.
  Build an ephemeral session in memory from `page.state.sessionState` or parsed
  search params: `actions` and `params`, and an autogenerated `name` from the first actionâ€™s label (e.g. Swap,
  Bridge).
- **Persist on first touch:** When the user first interacts with the form (focus
  or input in the session form area), create the session in the collection and
  navigate to `/session/<id>` (replace state).
- If there is no state or empty params, use the same ephemeral behaviour with a
  default single Swap action and name "Swap"; persist when the user touches the
  form.
- When an action slug includes JSON params (in `?actions=`), treat them as the initial `params`
  payload (partial values allowed) for the ephemeral session.

### Session navigation

- If the route is `/session/<id>`, load the session from the collection and
  hydrate the form from `params`.
- Any edit to form parameters updates `params` and `updatedAt` in the session.
- When the session is locked, form inputs that affect parameters are disabled
  and edits are rejected.

## Locking and results

- Simulation locks the session parameters, writes `lockedAt`, creates a new
  session simulation row, and updates `latestSimulationId` + `simulationCount`.
- Execution locks the session parameters, writes `execution.submittedAt`, and
  persists the transaction hash when known.
- Finalization updates `status` to `Finalized` and writes `finalization`.
- Locked sessions (simulated or submitted) can be forked into a new Draft
  session that copies `flows` and `params`, resets `status`, and clears lock,
  simulations, execution, and finalization fields.
- To change parameters after locking, create a new Draft session seeded from the
  locked session and navigate to its hash.

## Simulation storage

- Use a dedicated `transaction-session-simulations` TanStack DB collection.
- Each simulation row includes `sessionId` for joining and a params hash for
  grouping results by identical inputs.
- Session rows store only `latestSimulationId` and `simulationCount`.
- Simulation rows persist `paramsHash` to group results by identical inputs.

## Sessions route and navigation

- Introduce a dedicated sessions route: `/session`.
- Replace dedicated action routes (`/swap`, `/bridge`, `/transfer`) with the
  single `/session` route.
- Action views colocated in `src/routes/session/` (Bridge.svelte, Liquidity.svelte, Swap.svelte, Transfer.svelte); `/session` consumes them.
- **Navigation structure (superseded by spec 084):** Sessions, Accounts, Rooms, Coins, Networks nav children derive from `watchedEntitiesCollection` (sole source). Default entities seeded on profile creation.
- Session navigation items resolve to `/session?template=[action-slug]` (and session list to `/sessions`).

## Navigation tags

- Sessions parent: `[data-tag]` shows count of watched sessions. Child items: `[data-tag]` indicates `Draft`, `Submitted`, or `Finalized`.
- Action nav items resolve to `/session?template=[action-slug]`.

## Flow adoption

- Swap, bridge, and transfer actions read and write `Session.params`
  as the single source of truth.
- Action-specific view models derive from `params` without duplicating state.
- Form edits never mutate URL directly beyond navigating to `/session/<id>`.
- TransactionFlow owns execution orchestration, and actions only provide
  specifics.
- Intents resolve to a session with one or more actions, and params may be
  partially filled out.

## Acceptance criteria

- [x] `transaction-sessions` collection exists in TanStack DB with persistence.
- [x] Transaction flow routes accept action hashes (or empty); show an ephemeral
  session with autogenerated name; persist only on first form interaction and
  then replace the hash with `#/session:<id>`.
- [x] Routes hydrate form state from `Session.params`.
- [x] Any form edits sync back into the active session in TanStack DB.
- [x] Session params are normalized at the collection boundary using ArkType.
- [x] Simulation and execution lock parameter edits and persist results.
- [x] Simulations are stored in `transaction-session-simulations` with a
  `sessionId` join key.
- [x] Multiple simulations can be stored for the same locked params.
- [x] Sessions update to `Submitted` and `Finalized` with persisted metadata.
- [x] A new draft session is created when users change parameters after locking.
- [x] Locked sessions can be forked into a new Draft session with copied params.
- [x] Navigation includes Actions, Sessions, Accounts, Explore (Coins, Networks), Multiplayer (Rooms), Tests. Entity children from WatchedEntities (spec 084).
- [x] Session child items and Sessions/Rooms parents include `[data-tag]` (status or count).
- [x] Legacy hash formats are removed without backward compatibility shims.
- [x] `/session` is the single base route for all action flows.
- [x] Action views live in `src/routes/session/` (Bridge, Liquidity, Swap, Transfer) and are composed by `/session`.
- [x] Navigation items (Swap, Transfer, Bridge) target `/session#/[action-slug]`.
- [x] Session bootstrap supports multi-action hash syntax and JSON params;
  ephemeral session from hash; persist on first form touch.

## TODOs

- TODO: Confirm default `flow` values for each route.
- TODO: Define the minimal `params` shape per flow.
- TODO: Decide whether to expose session timestamps in UI.

## Status

Complete. Single base route `/session`; action views colocated in `src/routes/session/` (Bridge.svelte, Liquidity.svelte, Swap.svelte, Transfer.svelte) composed by session +page. Nav items target `/session#/[action-slug]`. Bootstrap: hash `#/action`, `#/action|action2`, `#/action:{JSON}` or empty builds an ephemeral session (name from first action label); session is persisted only on first form interaction, then hash is replaced with `#/session:<id>`.

## Output when complete

`DONE`
